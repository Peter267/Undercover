<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è°æ˜¯å§åº•</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  
  <link href="https://fontsapi.zeoseven.com/292/main/result.css" rel="stylesheet">

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#165DFF',
            secondary: '#FF7D00',
            danger: '#F53F3F',
            success: '#00B42A',
            warning: '#FF7D00',
            info: '#86909C',
            light: '#F2F3F5',
            dark: '#1D2129',
          },
          fontFamily: {
            sans: ['opposans', 'system-ui', 'sans-serif'],
          },
        },
      }
    }
  </script>
  
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&display=swap');
    
    body {
      font-family: 'LXGW WenKai', sans-serif;
    }

    .card-shadow {
      box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.05);
    }
    
    .backdrop-blur {
      backdrop-filter: blur(8px);
    }
    
    .perspective-1000 {
      perspective: 1000px;
    }
    
    .transform-style-3d {
      transform-style: preserve-3d;
    }
    
    .backface-hidden {
      backface-visibility: hidden;
    }
    
    .rotateY-180 {
      transform: rotateY(180deg);
    }
    
    .player-card-flipped {
      transform: rotateY(180deg);
    }
    
    .game-title {
      font-family: 'Ma Shan Zheng', cursive;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
    }
    
    .player-card {
      transition: transform 0.8s;
    }
    
    .role-card {
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
      border: 2px solid rgba(255, 255, 255, 0.5);
    }
    
    .player-avatar {
      transition: all 0.3s ease;
    }
    
    .player-avatar:hover {
      transform: translateY(-5px);
    }
    
    .player-avatar.voted {
      box-shadow: 0 0 0 3px #F53F3F;
    }
    
    .floating {
      animation: float 3s ease-in-out infinite;
    }
    
    @keyframes float {
      0% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
      100% { transform: translateY(0px); }
    }
    
    .pulse {
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(22, 93, 255, 0.4); }
      70% { box-shadow: 0 0 0 15px rgba(22, 93, 255, 0); }
      100% { box-shadow: 0 0 0 0 rgba(22, 93, 255, 0); }
    }
    
    .vote-bar {
      transition: width 0.5s ease-in-out;
    }
    
    .slide-out-left {
      animation: slideOutLeft 0.5s forwards;
    }
    
    .slide-in-right {
      animation: slideInRight 0.5s forwards;
    }
    
    @keyframes slideOutLeft {
      from { transform: translateX(0); opacity: 1; }
      to { transform: translateX(-100%); opacity: 0; }
    }
    
    @keyframes slideInRight {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    .word-display {
      min-height: 80px; display: flex; align-items: center; justify-content: center;
      font-size: 1.5rem; padding: 1rem; word-break: break-word;
      background: rgba(255, 255, 255, 0.7); border-radius: 12px;
      box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.05); margin: 0 1rem;
    }
    
    .action-buttons { margin-top: 1.5rem; margin-bottom: 1rem; }
    .role-avatar { margin: 1.5rem 0; }
    .next-player-btn-container {
      margin-top: auto; padding: 0 1.5rem; width: 100%; margin-bottom: 1.5rem;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen font-sans text-dark">
  <div class="container mx-auto px-4 py-8 max-w-4xl">
    <header class="text-center mb-10">
      <h1 class="text-4xl md:text-5xl font-bold text-primary mb-3 tracking-tight game-title">
        <i class="fa fa-user-secret mr-3"></i>è°æ˜¯å§åº•
      </h1>
      <p class="text-lg text-info max-w-2xl mx-auto">
        è€ƒéªŒè§‚å¯ŸåŠ›ã€æ¨ç†èƒ½åŠ›å’Œæ¼”æŠ€çš„ç»å…¸æ¡Œæ¸¸ï¼Œéšè—èº«ä»½æ‰¾å‡ºå§åº•ï¼
      </p>
    </header>
    
    <div id="gameView" class="transition-all duration-500 ease-in-out">
      <div id="startScreen" class="bg-white/90 backdrop-blur rounded-2xl p-8 card-shadow">
        <h2 class="text-2xl md:text-3xl font-bold text-center mb-8 text-primary">æ¸¸æˆè®¾ç½®</h2>
        
        <div class="mb-8">
          <label class="block text-lg font-medium mb-3 text-dark">æ¸¸æˆäººæ•°</label>
          <div class="flex items-center">
            <span class="text-sm text-gray-500 mr-2">3</span>
            <input type="range" id="playerCountSlider" min="3" max="10" value="6" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-primary">
            <span class="text-sm text-gray-500 ml-2">10</span>
          </div>
          <div class="text-center mt-2">
            <span id="playerCountValue" class="text-lg font-bold text-primary">6</span>
            <span class="text-lg text-dark"> äºº</span>
          </div>
          <p class="text-sm text-info mt-2 text-center">3-6äººï¼š1å§åº•ï¼Œ7-10äººï¼š2å§åº•</p>
        </div>
        
        <div class="mb-8 flex justify-center">
          <div class="bg-gray-100 rounded-lg p-4">
            <label class="flex items-center justify-center cursor-pointer">
              <input type="checkbox" id="hasBlankCard" class="hidden peer">
              <div class="relative w-14 h-7 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-primary"></div>
              <span class="ml-3 text-lg font-medium text-dark">å¯ç”¨ç™½æ¿</span>
            </label>
            <p id="blankCardWarning" class="text-sm text-danger mt-2 text-center hidden">æ³¨æ„ï¼š6åç©å®¶ä»¥ä¸Šæ‰èƒ½å¯ç”¨ç™½æ¿</p>
          </div>
        </div>
        
        <div class="text-center">
          <button id="startGameBtn" class="bg-primary hover:bg-primary/90 text-white font-bold py-3 px-8 rounded-full text-lg shadow-lg hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1 pulse">
            <i class="fa fa-play-circle mr-2"></i>å¼€å§‹æ¸¸æˆ
          </button>
        </div>
      </div>
      
      <div id="playerRoleScreen" class="hidden bg-white/90 backdrop-blur rounded-2xl p-8 card-shadow">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-2xl font-bold text-primary">ç©å®¶è§’è‰²</h2>
          <div class="text-lg font-medium">
            <span id="currentPlayer">1</span>
            <span class="text-gray-500">/</span>
            <span id="totalPlayers">6</span>
          </div>
        </div>
        <div class="relative h-96 perspective-1000 mb-6">
          <div id="playerCard" class="player-card relative w-full h-full transform-style-3d">
            <div class="role-card absolute w-full h-full backface-hidden bg-gradient-to-br from-blue-50 to-indigo-50 rounded-xl shadow-lg p-6 flex flex-col items-center justify-center">
              <div class="w-24 h-24 rounded-full bg-primary/10 flex items-center justify-center mb-4"><i class="fa fa-user-circle text-5xl text-primary"></i></div>
              <div class="text-2xl font-bold mb-2 text-primary">ç©å®¶ <span id="cardPlayerNumber">1</span></div>
              <p class="text-lg text-info mb-6 text-center">è¯·ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æŸ¥çœ‹ä½ çš„è§’è‰²</p>
              <div class="action-buttons">
                <button id="flipCardBtn" class="bg-primary hover:bg-primary/90 text-white font-bold py-3 px-8 rounded-full text-lg shadow-lg hover:shadow-xl transition-all duration-300"><i class="fa fa-eye mr-2"></i>æŸ¥çœ‹è§’è‰²</button>
              </div>
              <div class="text-xs text-gray-500 text-center mt-4"><p>æŸ¥çœ‹åè¯·ç¡®è®¤å®‰å…¨åä¼ é€’ç»™ä¸‹ä¸€ä½ç©å®¶</p></div>
            </div>
            <div class="role-card absolute w-full h-full backface-hidden bg-gradient-to-br from-blue-50 to-indigo-50 rounded-xl shadow-lg p-6 flex flex-col items-center justify-center rotateY-180">
              <div class="role-avatar w-24 h-24 rounded-full bg-primary/10 flex items-center justify-center"><i id="roleIcon" class="fa fa-user-secret text-5xl text-danger"></i></div>
              <div class="text-center my-4">
                <div id="cardRole" class="text-xl font-bold text-danger mb-2">å§åº•</div>
                <div class="text-sm text-gray-500 mb-1">ä½ çš„è¯è¯­æ˜¯ï¼š</div>
                <div id="cardWord" class="word-display font-bold">è¥¿ç“œ</div>
              </div>
              <div class="text-xs text-gray-500 mb-6 text-center max-w-xs">
                <p class="mb-1"><i class="fa fa-info-circle mr-1"></i> è¯·ç‰¢è®°ä½ çš„è¯è¯­ï¼Œä¸è¦è®©å…¶ä»–ç©å®¶çœ‹åˆ°</p>
                <p><i class="fa fa-lightbulb-o mr-1"></i> ç¡®è®¤å®‰å…¨åç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ä¼ é€’ç»™ä¸‹ä¸€ä½ç©å®¶</p>
              </div>
              <div class="next-player-btn-container">
                <button id="nextPlayerBtn" class="w-full bg-primary hover:bg-primary/90 text-white font-bold py-3 px-4 rounded-full text-lg shadow-lg hover:shadow-xl transition-all duration-300"><i class="fa fa-arrow-right mr-2"></i>ä¼ é€’ç»™ä¸‹ä¸€ä½ç©å®¶</button>
              </div>
            </div>
          </div>
        </div>
        <div class="bg-blue-50 rounded-lg p-4">
          <h3 class="font-bold text-primary mb-2"><i class="fa fa-info-circle mr-2"></i>æ¸¸æˆè§„åˆ™è¯´æ˜</h3>
          <ul class="text-sm text-gray-700 space-y-1">
            <li>â€¢ æŸ¥çœ‹è§’è‰²åè¯·å‹¿è®©å…¶ä»–ç©å®¶çœ‹åˆ°ä½ çš„è¯è¯­</li>
            <li>â€¢ ä¼ é€’è®¾å¤‡æ—¶ç¡®ä¿å±å¹•å†…å®¹å·²éšè—</li>
            <li>â€¢ æ‰€æœ‰ç©å®¶æŸ¥çœ‹å®Œæ¯•åè¿›å…¥å‘è¨€æŠ•ç¥¨ç¯èŠ‚</li>
            <li>â€¢ å§åº•çš„ç›®æ ‡æ˜¯éšè—èº«ä»½ï¼Œå¹³æ°‘çš„ç›®æ ‡æ˜¯æ‰¾å‡ºå§åº•</li>
          </ul>
        </div>
      </div>
      
      <div id="voteScreen" class="hidden bg-white/90 backdrop-blur rounded-2xl p-8 card-shadow">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-2xl font-bold text-primary">æŠ•ç¥¨ç¯èŠ‚</h2>
          <div class="text-lg font-medium"><span id="currentVoter">1</span><span class="text-gray-500">/</span><span id="totalVoters">6</span></div>
        </div>
        <div class="mb-6">
          <h3 class="text-xl font-bold mb-3 text-primary">è¯·æŠ•ç¥¨é€‰å‡ºä½ è®¤ä¸ºæ˜¯å§åº•çš„ç©å®¶</h3>
          <p class="text-info">ç‚¹å‡»ç©å®¶å¤´åƒè¿›è¡ŒæŠ•ç¥¨ï¼Œæ¯ä½ç©å®¶åªèƒ½æŠ•ä¸€ç¥¨</p>
        </div>
        <div id="playersContainer" class="grid grid-cols-2 sm:grid-cols-3 gap-4 mb-8"></div>
        <div id="voteConfirmation" class="hidden bg-primary/10 rounded-lg p-4">
          <h4 class="font-bold mb-2">ç¡®è®¤æŠ•ç¥¨</h4>
          <p class="mb-3">ä½ é€‰æ‹©æŠ•ç¥¨ç»™ <span id="confirmedVote" class="font-medium">ç©å®¶ 2</span></p>
          <div class="flex space-x-3">
            <button id="cancelVoteBtn" class="bg-gray-200 hover:bg-gray-300 text-dark font-medium py-2 px-4 rounded-lg transition-all duration-300 flex-1"><i class="fa fa-times mr-2"></i>å–æ¶ˆ</button>
            <button id="confirmVoteBtn" class="bg-primary hover:bg-primary/90 text-white font-medium py-2 px-4 rounded-lg transition-all duration-300 flex-1"><i class="fa fa-check mr-2"></i>ç¡®è®¤</button>
          </div>
        </div>
      </div>
      
      <div id="voteResultScreen" class="hidden bg-white/90 backdrop-blur rounded-2xl p-8 card-shadow">
        <h2 class="text-2xl font-bold text-center mb-8 text-primary">æŠ•ç¥¨ç»“æœ</h2>
        <div id="voteResultContent" class="bg-white rounded-xl shadow-lg p-6"></div>
        <div class="mt-8 text-center">
          <button id="continueBtn" class="bg-primary hover:bg-primary/90 text-white font-bold py-3 px-8 rounded-full text-lg shadow-lg hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1"><i class="fa fa-step-forward mr-2"></i>ç»§ç»­æ¸¸æˆ</button>
        </div>
      </div>
      
      <div id="gameEndScreen" class="hidden bg-white/90 backdrop-blur rounded-2xl p-8 card-shadow">
        <h2 id="endGameTitle" class="text-2xl font-bold text-center mb-8 text-primary"></h2>
        <div id="gameEndContent" class="bg-white rounded-xl shadow-lg p-6"></div>
        <div class="mt-8 text-center">
          <button id="restartBtn" class="bg-primary hover:bg-primary/90 text-white font-bold py-3 px-8 rounded-full text-lg shadow-lg hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1"><i class="fa fa-refresh mr-2"></i>é‡æ–°å¼€å§‹</button>
        </div>
      </div>
    </div>
  </div>
  
  <footer class="mt-12 text-center text-info text-sm pb-6">
    <p>Â© 2025 è°æ˜¯å§åº• åœ¨çº¿ç‰ˆ | ç»å…¸æ¡Œæ¸¸æ”¹ç¼–</p>
  </footer>
  
  <script>
    // DOM å…ƒç´ 
    const startScreen = document.getElementById('startScreen');
    const playerRoleScreen = document.getElementById('playerRoleScreen');
    const voteScreen = document.getElementById('voteScreen');
    const voteResultScreen = document.getElementById('voteResultScreen');
    const gameEndScreen = document.getElementById('gameEndScreen');
    const playerCountSlider = document.getElementById('playerCountSlider');
    const playerCountValue = document.getElementById('playerCountValue');
    const hasBlankCard = document.getElementById('hasBlankCard');
    const blankCardWarning = document.getElementById('blankCardWarning');
    const startGameBtn = document.getElementById('startGameBtn');
    const currentPlayer = document.getElementById('currentPlayer');
    const totalPlayers = document.getElementById('totalPlayers');
    const cardPlayerNumber = document.getElementById('cardPlayerNumber');
    const cardRole = document.getElementById('cardRole');
    const cardWord = document.getElementById('cardWord');
    const playerCard = document.getElementById('playerCard');
    const flipCardBtn = document.getElementById('flipCardBtn');
    const nextPlayerBtn = document.getElementById('nextPlayerBtn');
    const roleIcon = document.getElementById('roleIcon');
    const playersContainer = document.getElementById('playersContainer');
    const voteConfirmation = document.getElementById('voteConfirmation');
    const confirmedVote = document.getElementById('confirmedVote');
    const cancelVoteBtn = document.getElementById('cancelVoteBtn');
    const confirmVoteBtn = document.getElementById('confirmVoteBtn');
    const voteResultContent = document.getElementById('voteResultContent');
    const continueBtn = document.getElementById('continueBtn');
    const endGameTitle = document.getElementById('endGameTitle');
    const gameEndContent = document.getElementById('gameEndContent');
    const restartBtn = document.getElementById('restartBtn');
    const currentVoter = document.getElementById('currentVoter');
    const totalVoters = document.getElementById('totalVoters');
    
    // è¯åº“å’Œæ¸¸æˆæ•°æ®
    let wordLibrary = [];
    const gameData = {
      playerCount: 6,
      hasBlankCard: false,
      players: [],
      undercover: [],
      blank: null,
      currentPlayer: 1,
      currentVoter: 1,
      votes: {},
      eliminatedPlayers: [],
      currentRound: 1,
      wordPair: null
    };
    
    // ================= åŠŸèƒ½å‡½æ•° =================
    
    // å¼‚æ­¥åŠ è½½è¯åº“
    async function loadWordLibrary() {
      startGameBtn.disabled = true;
      startGameBtn.innerHTML = '<i class="fa fa-spinner fa-spin mr-2"></i>è¯åº“åŠ è½½ä¸­...';
      try {
        const response = await fetch('words.json');
        if (!response.ok) throw new Error(`HTTP é”™è¯¯! çŠ¶æ€: ${response.status}`);
        wordLibrary = await response.json();
        console.log('è¯åº“åŠ è½½æˆåŠŸ!');
        startGameBtn.disabled = false;
        startGameBtn.innerHTML = '<i class="fa fa-play-circle mr-2"></i>å¼€å§‹æ¸¸æˆ';
        startGameBtn.classList.add('pulse');
      } catch (error) {
        console.error("æ— æ³•åŠ è½½è¯åº“æ–‡ä»¶:", error);
        startGameBtn.textContent = 'è¯åº“åŠ è½½å¤±è´¥,è¯·åˆ·æ–°';
        startGameBtn.classList.remove('pulse');
      }
    }

    // æ›´æ–°ç©å®¶äººæ•°æ˜¾ç¤ºå’Œä¿å­˜è®¾ç½®
    function updatePlayerCount(count) {
        const newCount = parseInt(count);
        playerCountValue.textContent = newCount;
        gameData.playerCount = newCount;
        
        // æ£€æŸ¥ç™½æ¿é€‰é¡¹
        if (newCount < 6 && gameData.hasBlankCard) {
            gameData.hasBlankCard = false;
            hasBlankCard.checked = false;
            blankCardWarning.classList.remove('hidden');
        } else {
            blankCardWarning.classList.add('hidden');
        }
        
        // **æ ¸å¿ƒæ”¹åŠ¨ï¼šä¿å­˜äººæ•°åˆ° localStorage**
        localStorage.setItem('playerCount', newCount);
    }
    
    // ================= äº‹ä»¶ç›‘å¬ =================
    
    // é¡µé¢åŠ è½½å®Œæˆåï¼ŒåŠ è½½è¯åº“å’Œç”¨æˆ·è®¾ç½®
    document.addEventListener('DOMContentLoaded', () => {
        loadWordLibrary();
        
        // **æ ¸å¿ƒæ”¹åŠ¨ï¼šè¯»å– localStorage ä¸­çš„äººæ•°è®¾ç½®**
        const savedPlayerCount = localStorage.getItem('playerCount');
        if (savedPlayerCount) {
            playerCountSlider.value = savedPlayerCount;
            updatePlayerCount(savedPlayerCount); // ä½¿ç”¨ä¿å­˜çš„å€¼æ›´æ–°ç•Œé¢å’Œæ¸¸æˆæ•°æ®
        } else {
            // å¦‚æœæ²¡æœ‰ä¿å­˜è¿‡ï¼Œåˆ™ä½¿ç”¨é»˜è®¤å€¼åˆå§‹åŒ–
            updatePlayerCount(playerCountSlider.value);
        }
    });
    
    // ç›‘å¬æ»‘å—å˜åŠ¨
    playerCountSlider.addEventListener('input', (e) => {
      updatePlayerCount(e.target.value);
    });
    
    // ç›‘å¬ç™½æ¿é€‰é¡¹
    hasBlankCard.addEventListener('change', () => {
      gameData.hasBlankCard = hasBlankCard.checked;
      if (gameData.hasBlankCard && gameData.playerCount < 6) {
        gameData.hasBlankCard = false;
        hasBlankCard.checked = false;
        blankCardWarning.classList.remove('hidden');
      } else {
        blankCardWarning.classList.add('hidden');
      }
    });
    
    // å¼€å§‹æ¸¸æˆ
    startGameBtn.addEventListener('click', () => {
      if (wordLibrary.length === 0) {
        alert("è¯åº“å°šæœªåŠ è½½å®Œæˆæˆ–åŠ è½½å¤±è´¥ï¼Œè¯·ç¨å€™æˆ–åˆ·æ–°é¡µé¢ã€‚");
        return;
      }
      initGame();
      startScreen.classList.add('hidden');
      playerRoleScreen.classList.remove('hidden');
      updatePlayerRoleScreen();
    });
    
    // é‡æ–°å¼€å§‹æ¸¸æˆ
    restartBtn.addEventListener('click', () => {
      location.reload();
    });
    
    // ================= æ¸¸æˆæ ¸å¿ƒé€»è¾‘ (å¤§éƒ¨åˆ†æœªå˜) =================
    
    function initGame() {
      gameData.currentPlayer = 1;
      gameData.currentVoter = 1;
      gameData.currentRound = 1;
      gameData.votes = {};
      gameData.eliminatedPlayers = [];
      gameData.players = [];
      for (let i = 1; i <= gameData.playerCount; i++) {
        gameData.players.push({ id: i, isUndercover: false, isBlank: false, isEliminated: false });
      }
      const undercoverCount = gameData.playerCount <= 6 ? 1 : 2;
      gameData.undercover = [];
      while (gameData.undercover.length < undercoverCount) {
        const randomIndex = Math.floor(Math.random() * gameData.playerCount);
        if (!gameData.undercover.includes(randomIndex)) {
          gameData.undercover.push(randomIndex);
          gameData.players[randomIndex].isUndercover = true;
        }
      }
      if (gameData.hasBlankCard) {
        let blankIndex;
        do {
          blankIndex = Math.floor(Math.random() * gameData.playerCount);
        } while (gameData.undercover.includes(blankIndex));
        gameData.blank = blankIndex;
        gameData.players[blankIndex].isBlank = true;
      } else {
        gameData.blank = null;
      }
      const randomIndex = Math.floor(Math.random() * wordLibrary.length);
      gameData.wordPair = wordLibrary[randomIndex];
      totalPlayers.textContent = gameData.playerCount;
      totalVoters.textContent = gameData.playerCount;
    }

    function updatePlayerRoleScreen() {
      currentPlayer.textContent = gameData.currentPlayer;
      cardPlayerNumber.textContent = gameData.currentPlayer;
      playerCard.classList.remove('player-card-flipped');
      flipCardBtn.classList.remove('hidden', 'opacity-0');
      const player = gameData.players[gameData.currentPlayer - 1];
      if (player.isUndercover) {
        cardRole.textContent = 'å§åº•';
        cardRole.className = 'text-xl font-bold text-danger mb-2';
        cardWord.textContent = gameData.wordPair.word2;
        roleIcon.className = 'fa fa-user-secret text-4xl text-danger';
      } else if (player.isBlank) {
        cardRole.textContent = 'ç™½æ¿';
        cardRole.className = 'text-xl font-bold text-warning mb-2';
        cardWord.textContent = 'æ— ';
        roleIcon.className = 'fa fa-file-text-o text-4xl text-warning';
      } else {
        cardRole.textContent = 'å¹³æ°‘';
        cardRole.className = 'text-xl font-bold text-info mb-2';
        cardWord.textContent = gameData.wordPair.word1;
        roleIcon.className = 'fa fa-user text-4xl text-info';
      }
    }

    flipCardBtn.addEventListener('click', () => {
      playerCard.classList.add('player-card-flipped');
      flipCardBtn.classList.add('opacity-0');
      setTimeout(() => flipCardBtn.classList.add('hidden'), 500);
    });

    nextPlayerBtn.addEventListener('click', () => {
      playerCard.classList.remove('player-card-flipped');
      flipCardBtn.classList.remove('hidden', 'opacity-0');
      playerRoleScreen.classList.add('slide-out-left');
      setTimeout(() => {
        playerRoleScreen.classList.remove('slide-out-left');
        if (gameData.currentPlayer === gameData.playerCount) {
          playerRoleScreen.classList.add('hidden');
          voteScreen.classList.remove('hidden');
          renderVotePlayers();
        } else {
          gameData.currentPlayer++;
          playerRoleScreen.classList.add('slide-in-right');
          updatePlayerRoleScreen();
          setTimeout(() => playerRoleScreen.classList.remove('slide-in-right'), 500);
        }
      }, 500);
    });

    function renderVotePlayers() {
      playersContainer.innerHTML = '';
      voteConfirmation.classList.add('hidden');
      const activePlayers = gameData.players.filter(p => !p.isEliminated && p.id !== gameData.currentVoter);
      activePlayers.forEach(player => {
        const playerEl = document.createElement('div');
        playerEl.className = 'player-avatar bg-white hover:bg-primary/10 rounded-lg shadow-md p-4 transition-all duration-300 cursor-pointer flex flex-col items-center';
        playerEl.innerHTML = `<div class="w-16 h-16 rounded-full bg-primary/10 flex items-center justify-center mb-2"><span class="text-xl font-bold text-primary">${player.id}</span></div><span class="font-medium">ç©å®¶ ${player.id}</span>`;
        playerEl.addEventListener('click', () => {
          confirmedVote.textContent = `ç©å®¶ ${player.id}`;
          voteConfirmation.classList.remove('hidden');
          voteConfirmation.dataset.vote = player.id;
        });
        playersContainer.appendChild(playerEl);
      });
    }

    cancelVoteBtn.addEventListener('click', () => voteConfirmation.classList.add('hidden'));

    confirmVoteBtn.addEventListener('click', () => {
      const votedPlayer = parseInt(voteConfirmation.dataset.vote);
      gameData.votes[votedPlayer] = (gameData.votes[votedPlayer] || 0) + 1;
      const remainingVoters = gameData.players.filter(p => !p.isEliminated);
      if (gameData.currentVoter === remainingVoters.length) {
          voteScreen.classList.add('hidden');
          voteResultScreen.classList.remove('hidden');
          renderVoteResult();
      } else {
          gameData.currentVoter++;
          currentVoter.textContent = gameData.currentVoter;
          voteConfirmation.classList.add('hidden');
          renderVotePlayers();
      }
    });

    function renderVoteResult() {
        voteResultContent.innerHTML = '';
        let maxVotes = 0;
        let topPlayers = [];
        const activePlayerIds = gameData.players.filter(p => !p.isEliminated).map(p => p.id);
        for (const playerId in gameData.votes) {
            if (activePlayerIds.includes(parseInt(playerId))) {
                const voteCount = gameData.votes[playerId];
                if (voteCount > maxVotes) {
                    maxVotes = voteCount;
                    topPlayers = [parseInt(playerId)];
                } else if (voteCount === maxVotes) {
                    topPlayers.push(parseInt(playerId));
                }
            }
        }
        let resultHTML = '<h3 class="text-xl font-bold text-primary mb-4">æœ¬è½®æŠ•ç¥¨ç»“æœ</h3>';
        if (topPlayers.length === 0 || maxVotes === 0) {
            resultHTML += '<p class="text-info text-lg">æœ¬è½®æ— äººæŠ•ç¥¨ï¼Œæ— äººå‡ºå±€ã€‚</p>';
            continueBtn.textContent = 'ç»§ç»­æ¸¸æˆ';
        } else if (topPlayers.length > 1) {
            resultHTML += `<p class="text-warning text-lg">ç©å®¶ ${topPlayers.join('ã€')} å¹³ç¥¨ï¼Œæ— äººå‡ºå±€ã€‚</p>`;
            continueBtn.textContent = 'ç»§ç»­ä¸‹ä¸€è½®';
        } else {
            const eliminatedPlayerId = topPlayers[0];
            const eliminatedPlayer = gameData.players.find(p => p.id === eliminatedPlayerId);
            eliminatedPlayer.isEliminated = true;
            gameData.eliminatedPlayers.push(eliminatedPlayerId);
            let roleText = eliminatedPlayer.isUndercover ? 'å§åº•' : (eliminatedPlayer.isBlank ? 'ç™½æ¿' : 'å¹³æ°‘');
            resultHTML += `<p class="text-danger text-lg mb-4">ç©å®¶ ${eliminatedPlayerId} ä»¥ ${maxVotes} ç¥¨è¢«æ·˜æ±°ï¼</p>`;
            resultHTML += `<p class="text-xl font-bold">ä»–çš„èº«ä»½æ˜¯ï¼š<span class="text-primary">${roleText}</span></p>`;
            continueBtn.textContent = 'æŸ¥çœ‹æ¸¸æˆçŠ¶æ€';
        }
        voteResultContent.innerHTML = resultHTML;
        if (checkGameEnd()) {
          continueBtn.classList.add('hidden');
        } else {
          continueBtn.classList.remove('hidden');
        }
    }
    
    continueBtn.addEventListener('click', () => {
        if (checkGameEnd()) return;
        gameData.votes = {};
        gameData.currentRound++;
        const activePlayers = gameData.players.filter(p => !p.isEliminated);
        gameData.currentVoter = 1;
        totalVoters.textContent = activePlayers.length;
        currentVoter.textContent = 1;
        voteResultScreen.classList.add('hidden');
        voteScreen.classList.remove('hidden');
        renderVotePlayers();
    });

    function checkGameEnd() {
        const activePlayers = gameData.players.filter(p => !p.isEliminated);
        const activeUndercover = activePlayers.filter(p => p.isUndercover);
        const activeBlank = activePlayers.filter(p => p.isBlank);
        const activeCivilians = activePlayers.filter(p => !p.isUndercover && !p.isBlank);
        let isEnd = false, title = '', content = '';
        if (activeUndercover.length === 0 && activeBlank.length === 0) {
            isEnd = true; title = 'ğŸ‰ å¹³æ°‘èƒœåˆ©ï¼ ğŸ‰'; content = '<p>æ‰€æœ‰å§åº•å’Œç™½æ¿éƒ½å·²è¢«æ‰¾å‡ºï¼</p>';
        } else if (activeCivilians.length === 0 && activeUndercover.length > 0) {
            isEnd = true; title = 'ğŸ‘» å§åº•èƒœåˆ©ï¼ ğŸ‘»'; content = '<p>æ‰€æœ‰å¹³æ°‘éƒ½å·²è¢«æ·˜æ±°ï¼</p>';
        } else if (activePlayers.length <= 2) {
             if (activeUndercover.length > 0) {
                isEnd = true; title = 'ğŸ‘» å§åº•èƒœåˆ©ï¼ ğŸ‘»'; content = '<p>åœºä¸Šç©å®¶è¿‡å°‘ï¼Œå§åº•æˆåŠŸéšè—åˆ°æœ€åï¼</p>';
             } else if (activeBlank.length > 0) {
                isEnd = true; title = 'ğŸƒ ç™½æ¿èƒœåˆ©ï¼ ğŸƒ'; content = '<p>ç™½æ¿æˆåŠŸå­˜æ´»åˆ°æœ€åï¼</p>';
             }
        }
        if (isEnd) {
            endGameTitle.innerHTML = title;
            gameEndContent.innerHTML = `<div class="text-center">${content}<div class="mt-6 p-4 bg-gray-100 rounded-lg"><p class="font-bold mb-2">æœ¬å±€è¯è¯­</p><p>å¹³æ°‘è¯: <span class="font-bold text-primary">${gameData.wordPair.word1}</span></p><p>å§åº•è¯: <span class="font-bold text-danger">${gameData.wordPair.word2}</span></p></div></div>`;
            voteResultScreen.classList.add('hidden');
            gameEndScreen.classList.remove('hidden');
            voteScreen.classList.add('hidden');
            return true;
        }
        return false;
    }
  </script>
</body>
</html>
